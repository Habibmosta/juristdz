<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Final - Bouton Traduction</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8fafc;
        }
        .header {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }
        .chat-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .chat-header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-title {
            font-size: 20px;
            font-weight: bold;
            color: #1f2937;
        }
        .translation-buttons {
            display: flex;
            gap: 8px;
        }
        .btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background: #2563eb;
        }
        .btn-success {
            background: #10b981;
            color: white;
            font-size: 12px;
            padding: 6px 12px;
        }
        .btn-success:hover:not(:disabled) {
            background: #059669;
        }
        .messages {
            padding: 24px;
            max-height: 400px;
            overflow-y: auto;
        }
        .message {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }
        .message.user {
            justify-content: flex-end;
        }
        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 16px;
            position: relative;
        }
        .message.user .message-content {
            background: #3b82f6;
            color: white;
            margin-left: 32px;
        }
        .message.bot .message-content {
            background: #f3f4f6;
            color: #1f2937;
            margin-right: 32px;
            border: 1px solid #e5e7eb;
        }
        .message-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 12px;
            opacity: 0.7;
        }
        .translation-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            color: #3b82f6;
            font-size: 10px;
        }
        .language-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        .lang-btn {
            padding: 8px 16px;
            border: 2px solid #3b82f6;
            background: white;
            color: #3b82f6;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        .lang-btn.active {
            background: #3b82f6;
            color: white;
        }
        .status {
            padding: 12px;
            margin: 16px 0;
            border-radius: 8px;
            font-weight: bold;
        }
        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        .status.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #3b82f6;
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üåê Test Final - Bouton de Traduction</h1>
        <p>Simulation de l'interface ImprovedChatInterface avec les boutons de traduction</p>
    </div>

    <div class="language-selector">
        <button class="lang-btn active" id="btn-fr" onclick="setLanguage('fr')">üá´üá∑ Fran√ßais</button>
        <button class="lang-btn" id="btn-ar" onclick="setLanguage('ar')">üá©üáø ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</button>
    </div>

    <div class="chat-container">
        <div class="chat-header">
            <div>
                <div class="chat-title" id="chat-title">Recherche Juridique</div>
                <div style="font-size: 14px; color: #6b7280;" id="chat-subtitle">Expertise en droit alg√©rien</div>
            </div>
            
            <div class="translation-buttons">
                <button class="btn btn-primary" id="translate-btn" onclick="translateMessages()">
                    <span id="translate-icon">üåê</span>
                    <span id="translate-text">Traduire les messages</span>
                </button>
                
                <button class="btn btn-success" id="direct-translate-btn" onclick="directTranslateMessages()">
                    <span>üîß</span>
                    <span id="direct-translate-text">Traduction directe</span>
                </button>
            </div>
        </div>

        <div class="messages" id="messages-container">
            <!-- Messages will be inserted here -->
        </div>
    </div>

    <div id="status-container"></div>

    <script>
        let currentLanguage = 'fr';
        let isTranslating = false;
        
        // Messages de test
        let messages = [
            {
                id: '1',
                text: 'Bonjour ! Comment puis-je vous aider avec votre question juridique ?',
                originalText: 'Bonjour ! Comment puis-je vous aider avec votre question juridique ?',
                originalLang: 'fr',
                sender: 'bot',
                isTranslated: false,
                translatedText: undefined
            },
            {
                id: '2',
                text: 'Je voudrais des informations sur la commune en droit alg√©rien.',
                originalText: 'Je voudrais des informations sur la commune en droit alg√©rien.',
                originalLang: 'fr',
                sender: 'user',
                isTranslated: false,
                translatedText: undefined
            },
            {
                id: '3',
                text: 'La commune est une entit√© administrative alg√©rienne qui constitue la plus petite unit√© de collectivit√© locale. Elle est d√©finie dans le Code des Collectivit√©s Locales comme une collectivit√© territoriale dot√©e de la personnalit√© morale et de l\'autonomie financi√®re.',
                originalText: 'La commune est une entit√© administrative alg√©rienne qui constitue la plus petite unit√© de collectivit√© locale. Elle est d√©finie dans le Code des Collectivit√©s Locales comme une collectivit√© territoriale dot√©e de la personnalit√© morale et de l\'autonomie financi√®re.',
                originalLang: 'fr',
                sender: 'bot',
                isTranslated: false,
                translatedText: undefined
            }
        ];

        // Traductions UI
        const uiTranslations = {
            fr: {
                chatTitle: 'Recherche Juridique',
                chatSubtitle: 'Expertise en droit alg√©rien',
                translateBtn: 'Traduire les messages',
                directTranslateBtn: 'Traduction directe',
                translating: 'Traduction en cours...',
                you: 'Vous',
                bot: 'JuristDZ',
                translated: 'Traduit'
            },
            ar: {
                chatTitle: 'ÿ®ÿ≠ÿ´ ŸÇÿßŸÜŸàŸÜŸä',
                chatSubtitle: 'ÿÆÿ®ÿ±ÿ© ŸÅŸä ÿßŸÑŸÇÿßŸÜŸàŸÜ ÿßŸÑÿ¨ÿ≤ÿßÿ¶ÿ±Ÿä',
                translateBtn: 'ÿ™ÿ±ÿ¨ŸÖÿ© ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ',
                directTranslateBtn: 'ÿ™ÿ±ÿ¨ŸÖÿ© ŸÖÿ®ÿßÿ¥ÿ±ÿ©',
                translating: 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ±ÿ¨ŸÖÿ©...',
                you: 'ÿ£ŸÜÿ™',
                bot: 'JuristDZ',
                translated: 'ŸÖÿ™ÿ±ÿ¨ŸÖ'
            }
        };

        // Dictionnaire de traduction directe
        const translations = {
            'fr_to_ar': {
                'Bonjour ! Comment puis-je vous aider avec votre question juridique ?': 'ŸÖÿ±ÿ≠ÿ®ÿß! ŸÉŸäŸÅ ŸäŸÖŸÉŸÜŸÜŸä ŸÖÿ≥ÿßÿπÿØÿ™ŸÉ ŸÅŸä ÿ≥ÿ§ÿßŸÑŸÉ ÿßŸÑŸÇÿßŸÜŸàŸÜŸäÿü',
                'Je voudrais des informations sur la commune en droit alg√©rien.': 'ÿ£ÿ±ŸäÿØ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ≠ŸàŸÑ ÿßŸÑÿ®ŸÑÿØŸäÿ© ŸÅŸä ÿßŸÑŸÇÿßŸÜŸàŸÜ ÿßŸÑÿ¨ÿ≤ÿßÿ¶ÿ±Ÿä.',
                'La commune est une entit√© administrative alg√©rienne qui constitue la plus petite unit√© de collectivit√© locale. Elle est d√©finie dans le Code des Collectivit√©s Locales comme une collectivit√© territoriale dot√©e de la personnalit√© morale et de l\'autonomie financi√®re.': 'ÿßŸÑÿ®ŸÑÿØŸäÿ© ŸáŸä Ÿàÿ≠ÿØÿ© ÿ•ÿØÿßÿ±Ÿäÿ© ÿ¨ÿ≤ÿßÿ¶ÿ±Ÿäÿ© ÿ™ÿ¥ŸÉŸÑ ÿ£ÿµÿ∫ÿ± Ÿàÿ≠ÿØÿ© ŸÅŸä ÿßŸÑÿ¨ŸÖÿßÿπÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©. ŸàŸáŸä ŸÖÿπÿ±ŸÅÿ© ŸÅŸä ŸÇÿßŸÜŸàŸÜ ÿßŸÑÿ¨ŸÖÿßÿπÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ© ŸÉÿ¨ŸÖÿßÿπÿ© ÿ•ŸÇŸÑŸäŸÖŸäÿ© ÿ™ÿ™ŸÖÿ™ÿπ ÿ®ÿßŸÑÿ¥ÿÆÿµŸäÿ© ÿßŸÑŸÖÿπŸÜŸàŸäÿ© ŸàÿßŸÑÿßÿ≥ÿ™ŸÇŸÑÿßŸÑŸäÿ© ÿßŸÑŸÖÿßŸÑŸäÿ©.',
                'Bonjour': 'ŸÖÿ±ÿ≠ÿ®ÿß',
                'Comment puis-je vous aider': 'ŸÉŸäŸÅ ŸäŸÖŸÉŸÜŸÜŸä ŸÖÿ≥ÿßÿπÿØÿ™ŸÉ',
                'question juridique': 'ÿ≥ÿ§ÿßŸÑ ŸÇÿßŸÜŸàŸÜŸä',
                'commune': 'ÿßŸÑÿ®ŸÑÿØŸäÿ©',
                'droit alg√©rien': 'ÿßŸÑŸÇÿßŸÜŸàŸÜ ÿßŸÑÿ¨ÿ≤ÿßÿ¶ÿ±Ÿä',
                'entit√© administrative': 'Ÿàÿ≠ÿØÿ© ÿ•ÿØÿßÿ±Ÿäÿ©',
                'collectivit√© locale': 'ÿ¨ŸÖÿßÿπÿ© ŸÖÿ≠ŸÑŸäÿ©',
                'Code des Collectivit√©s Locales': 'ŸÇÿßŸÜŸàŸÜ ÿßŸÑÿ¨ŸÖÿßÿπÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©',
                'personnalit√© morale': 'ÿßŸÑÿ¥ÿÆÿµŸäÿ© ÿßŸÑŸÖÿπŸÜŸàŸäÿ©',
                'autonomie financi√®re': 'ÿßŸÑÿßÿ≥ÿ™ŸÇŸÑÿßŸÑŸäÿ© ÿßŸÑŸÖÿßŸÑŸäÿ©'
            },
            'ar_to_fr': {
                'ŸÖÿ±ÿ≠ÿ®ÿß! ŸÉŸäŸÅ ŸäŸÖŸÉŸÜŸÜŸä ŸÖÿ≥ÿßÿπÿØÿ™ŸÉ ŸÅŸä ÿ≥ÿ§ÿßŸÑŸÉ ÿßŸÑŸÇÿßŸÜŸàŸÜŸäÿü': 'Bonjour ! Comment puis-je vous aider avec votre question juridique ?',
                'ÿ£ÿ±ŸäÿØ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ≠ŸàŸÑ ÿßŸÑÿ®ŸÑÿØŸäÿ© ŸÅŸä ÿßŸÑŸÇÿßŸÜŸàŸÜ ÿßŸÑÿ¨ÿ≤ÿßÿ¶ÿ±Ÿä.': 'Je voudrais des informations sur la commune en droit alg√©rien.',
                'ÿßŸÑÿ®ŸÑÿØŸäÿ© ŸáŸä Ÿàÿ≠ÿØÿ© ÿ•ÿØÿßÿ±Ÿäÿ© ÿ¨ÿ≤ÿßÿ¶ÿ±Ÿäÿ© ÿ™ÿ¥ŸÉŸÑ ÿ£ÿµÿ∫ÿ± Ÿàÿ≠ÿØÿ© ŸÅŸä ÿßŸÑÿ¨ŸÖÿßÿπÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©. ŸàŸáŸä ŸÖÿπÿ±ŸÅÿ© ŸÅŸä ŸÇÿßŸÜŸàŸÜ ÿßŸÑÿ¨ŸÖÿßÿπÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ© ŸÉÿ¨ŸÖÿßÿπÿ© ÿ•ŸÇŸÑŸäŸÖŸäÿ© ÿ™ÿ™ŸÖÿ™ÿπ ÿ®ÿßŸÑÿ¥ÿÆÿµŸäÿ© ÿßŸÑŸÖÿπŸÜŸàŸäÿ© ŸàÿßŸÑÿßÿ≥ÿ™ŸÇŸÑÿßŸÑŸäÿ© ÿßŸÑŸÖÿßŸÑŸäÿ©.': 'La commune est une entit√© administrative alg√©rienne qui constitue la plus petite unit√© de collectivit√© locale. Elle est d√©finie dans le Code des Collectivit√©s Locales comme une collectivit√© territoriale dot√©e de la personnalit√© morale et de l\'autonomie financi√®re.',
                'ŸÖÿ±ÿ≠ÿ®ÿß': 'Bonjour',
                'ŸÉŸäŸÅ ŸäŸÖŸÉŸÜŸÜŸä ŸÖÿ≥ÿßÿπÿØÿ™ŸÉ': 'Comment puis-je vous aider',
                'ÿ≥ÿ§ÿßŸÑ ŸÇÿßŸÜŸàŸÜŸä': 'question juridique',
                'ÿßŸÑÿ®ŸÑÿØŸäÿ©': 'commune',
                'ÿßŸÑŸÇÿßŸÜŸàŸÜ ÿßŸÑÿ¨ÿ≤ÿßÿ¶ÿ±Ÿä': 'droit alg√©rien',
                'Ÿàÿ≠ÿØÿ© ÿ•ÿØÿßÿ±Ÿäÿ©': 'entit√© administrative',
                'ÿ¨ŸÖÿßÿπÿ© ŸÖÿ≠ŸÑŸäÿ©': 'collectivit√© locale',
                'ŸÇÿßŸÜŸàŸÜ ÿßŸÑÿ¨ŸÖÿßÿπÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©': 'Code des Collectivit√©s Locales',
                'ÿßŸÑÿ¥ÿÆÿµŸäÿ© ÿßŸÑŸÖÿπŸÜŸàŸäÿ©': 'personnalit√© morale',
                'ÿßŸÑÿßÿ≥ÿ™ŸÇŸÑÿßŸÑŸäÿ© ÿßŸÑŸÖÿßŸÑŸäÿ©': 'autonomie financi√®re'
            }
        };

        function setLanguage(lang) {
            currentLanguage = lang;
            
            // Update UI
            document.getElementById('btn-fr').classList.toggle('active', lang === 'fr');
            document.getElementById('btn-ar').classList.toggle('active', lang === 'ar');
            
            updateUI();
            renderMessages();
            
            showStatus(`Langue chang√©e vers ${lang === 'fr' ? 'Fran√ßais' : 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©'}`, 'info');
        }

        function updateUI() {
            const t = uiTranslations[currentLanguage];
            document.getElementById('chat-title').textContent = t.chatTitle;
            document.getElementById('chat-subtitle').textContent = t.chatSubtitle;
            document.getElementById('translate-text').textContent = isTranslating ? t.translating : t.translateBtn;
            document.getElementById('direct-translate-text').textContent = t.directTranslateBtn;
        }

        function getDirectTranslation(text, fromLang, toLang) {
            if (!text || typeof text !== 'string') return text;
            if (fromLang === toLang) return text;
            
            const translationKey = `${fromLang}_to_${toLang}`;
            const translationDict = translations[translationKey];
            
            if (!translationDict) return text;
            
            let translated = text;
            
            // Apply translations (longest phrases first for better matching)
            const sortedKeys = Object.keys(translationDict).sort((a, b) => b.length - a.length);
            
            sortedKeys.forEach(key => {
                const value = translationDict[key];
                if (translated.includes(key)) {
                    translated = translated.replace(new RegExp(key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi'), value);
                    console.log(`üîÑ Traduction appliqu√©e: "${key}" -> "${value}"`);
                }
            });
            
            return translated;
        }

        async function translateMessages() {
            console.log('üåê TRADUCTION MANUELLE - D√©but');
            console.log(`üåê Langue cible: ${currentLanguage}`);
            console.log(`üåê Nombre de messages: ${messages.length}`);
            
            if (messages.length === 0) {
                showStatus('Aucun message √† traduire', 'error');
                return;
            }
            
            setTranslating(true);
            showStatus('Traduction en cours avec le service avanc√©...', 'info');
            
            try {
                const translatedMessages = [];
                
                for (const message of messages) {
                    const sourceText = message.originalText;
                    const sourceLang = message.originalLang;
                    
                    // Si m√™me langue, garder l'original
                    if (sourceLang === currentLanguage) {
                        translatedMessages.push({
                            ...message,
                            text: sourceText,
                            isTranslated: false,
                            translatedText: undefined
                        });
                        continue;
                    }

                    try {
                        console.log(`üåê Traduction: ${sourceLang} ‚Üí ${currentLanguage}`);
                        console.log(`üåê Texte: "${sourceText.substring(0, 50)}..."`);
                        
                        // Simuler un appel au service de traduction avanc√©
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        // Utiliser la traduction directe comme fallback
                        const translatedText = getDirectTranslation(sourceText, sourceLang, currentLanguage);

                        console.log(`üåê R√©sultat: "${translatedText.substring(0, 50)}..."`);

                        const isSuccessful = translatedText !== sourceText && 
                                           translatedText.trim().length > 0;
                        
                        translatedMessages.push({
                            ...message,
                            text: isSuccessful ? translatedText : sourceText,
                            originalText: sourceText,
                            originalLang: sourceLang,
                            translatedText: isSuccessful ? translatedText : undefined,
                            isTranslated: isSuccessful
                        });
                        
                    } catch (error) {
                        console.error('üåê ‚ùå Erreur traduction message:', error);
                        translatedMessages.push({
                            ...message,
                            text: sourceText,
                            originalText: sourceText,
                            originalLang: sourceLang,
                            translatedText: undefined,
                            isTranslated: false
                        });
                    }
                }

                console.log(`üåê Mise √† jour de ${translatedMessages.length} messages`);
                messages = translatedMessages;
                renderMessages();
                
                const successCount = translatedMessages.filter(m => m.isTranslated).length;
                showStatus(`‚úÖ Traduction termin√©e avec succ√®s! ${successCount} messages traduits.`, 'success');
                console.log('üåê ‚úÖ Traduction termin√©e avec succ√®s');
                
            } catch (error) {
                console.error('üåê ‚ùå Erreur traduction globale:', error);
                showStatus(`‚ùå Erreur de traduction: ${error.message}`, 'error');
            } finally {
                setTranslating(false);
            }
        }

        function directTranslateMessages() {
            console.log('üîß TRADUCTION DIRECTE - Fallback simple');
            
            if (messages.length === 0) {
                showStatus('Aucun message √† traduire', 'error');
                return;
            }
            
            setTranslating(true);
            showStatus('Traduction directe en cours...', 'info');
            
            try {
                const translatedMessages = messages.map((message) => {
                    const sourceText = message.originalText;
                    const sourceLang = message.originalLang;
                    
                    // Si m√™me langue, garder l'original
                    if (sourceLang === currentLanguage) {
                        return {
                            ...message,
                            text: sourceText,
                            isTranslated: false,
                            translatedText: undefined
                        };
                    }

                    // Utiliser la traduction directe int√©gr√©e
                    const translatedText = getDirectTranslation(sourceText, sourceLang, currentLanguage);
                    
                    console.log(`üîß Traduction directe: "${sourceText.substring(0, 30)}..." ‚Üí "${translatedText.substring(0, 30)}..."`);

                    return {
                        ...message,
                        text: translatedText,
                        originalText: sourceText,
                        originalLang: sourceLang,
                        translatedText: translatedText,
                        isTranslated: true
                    };
                });
                
                messages = translatedMessages;
                renderMessages();
                
                const successCount = translatedMessages.filter(m => m.isTranslated).length;
                showStatus(`‚úÖ Traduction directe termin√©e! ${successCount} messages traduits.`, 'success');
                console.log('üîß ‚úÖ Traduction directe termin√©e');
                
            } catch (error) {
                console.error('üîß ‚ùå Erreur traduction directe:', error);
                showStatus(`‚ùå Erreur de traduction directe: ${error.message}`, 'error');
            } finally {
                setTranslating(false);
            }
        }

        function setTranslating(translating) {
            isTranslating = translating;
            document.getElementById('translate-btn').disabled = translating;
            document.getElementById('direct-translate-btn').disabled = translating;
            
            const icon = document.getElementById('translate-icon');
            if (translating) {
                icon.classList.add('animate-pulse');
            } else {
                icon.classList.remove('animate-pulse');
            }
            
            updateUI();
        }

        function renderMessages() {
            const container = document.getElementById('messages-container');
            const t = uiTranslations[currentLanguage];
            
            container.innerHTML = messages.map(message => `
                <div class="message ${message.sender}">
                    <div class="message-content">
                        <div class="message-meta">
                            <span>${message.sender === 'user' ? t.you : t.bot}</span>
                            ${message.isTranslated ? `
                                <div class="translation-indicator">
                                    <span>üåê</span>
                                    <span>${t.translated}</span>
                                </div>
                            ` : ''}
                        </div>
                        <div style="direction: ${currentLanguage === 'ar' ? 'rtl' : 'ltr'};">
                            ${message.text}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showStatus(message, type) {
            const container = document.getElementById('status-container');
            container.innerHTML = `<div class="status ${type}">${message}</div>`;
            
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // Initialisation
        updateUI();
        renderMessages();
        showStatus('‚úÖ Interface de test charg√©e. Cliquez sur les boutons pour tester la traduction!', 'success');
    </script>
</body>
</html>